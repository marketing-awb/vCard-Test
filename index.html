<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCF Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .vcf-table-container, .export-selection-container {
            max-height: 80vh; /* Increased for better visibility */
            overflow: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            background-color: white;
            flex-grow: 1; /* Allows it to fill the right panel */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            white-space: nowrap;
        }
        thead th {
            background-color: #e5e7eb;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tbody tr:hover {
            background-color: #eef2ff;
        }
        .message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
        }
        .message-box.visible {
            opacity: 1;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body>

<div id="app" class="container bg-white rounded-xl shadow-lg my-8 p-8 md:p-12">
    <div id="message-box" class="message-box bg-gray-800 text-white"></div>
    
    <h1 class="text-4xl md:text-5xl font-bold mb-4 text-center text-gray-800">Local VCF Editor</h1>
    <p class="text-center text-gray-600 mb-8">
        Upload, edit, and export VCF files directly on your computer.
    </p>

    <div class="flex flex-col md:flex-row gap-8">
        <!-- Left Panel for Buttons -->
        <div class="flex-shrink-0 w-full md:w-64 bg-gray-100 p-4 rounded-lg flex flex-col gap-4">
            <label for="file-input" class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200 text-center">
                Upload VCF File
            </label>
            <input id="file-input" type="file" accept=".vcf" class="hidden">
            
            <div id="dynamic-buttons-container" class="hidden flex flex-col gap-4">
                <button id="add-contact-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Add New Contact
                </button>
                <button id="export-selected-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Export Selected
                </button>
                <button id="delete-selected-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Delete Selected
                </button>
            </div>
        </div>
        
        <!-- Right Panel for VCF Table and Export List -->
        <div class="flex-grow flex flex-col gap-8">
            <div class="vcf-table-container">
                <table id="vcf-table">
                    <thead>
                        <!-- VCF header will be rendered here -->
                    </thead>
                    <tbody>
                        <!-- VCF data will be rendered here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Export Selection List -->
            <div id="export-selection-container" class="export-selection-container p-4 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Select Contacts to Export</h3>
                    <div class="flex items-center gap-2">
                        <label for="export-select-all-checkbox" class="text-sm text-gray-600">Select All</label>
                        <input type="checkbox" id="export-select-all-checkbox">
                    </div>
                </div>
                <ul id="export-list" class="space-y-2">
                    <!-- Checkbox list will be rendered here -->
                </ul>
                <div class="mt-4 flex justify-end">
                    <button id="download-selected-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200 opacity-50 cursor-not-allowed" disabled>
                        Download Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-gray-800">Edit Contact</h2>
        <form id="contact-form" class="space-y-4">
            <input type="hidden" id="modal-row-index">
            <div class="flex flex-col">
                <label for="modal-fn" class="text-sm font-medium text-gray-700">Full Name (FN)</label>
                <input type="text" id="modal-fn" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col">
                <label for="modal-tel" class="text-sm font-medium text-gray-700">Telephone (TEL)</label>
                <input type="tel" id="modal-tel" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col">
                <label for="modal-email" class="text-sm font-medium text-gray-700">Email (EMAIL)</label>
                <input type="email" id="modal-email" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col">
                <label for="modal-org" class="text-sm font-medium text-gray-700">Organization (ORG)</label>
                <input type="text" id="modal-org" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col">
                <label for="modal-adr" class="text-sm font-medium text-gray-700">Address (ADR)</label>
                <input type="text" id="modal-adr" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col">
                <label for="modal-note" class="text-sm font-medium text-gray-700">Note (NOTE)</label>
                <textarea id="modal-note" rows="3" class="p-3 mt-1 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="modal-delete-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Delete
                </button>
                <button type="button" id="modal-cancel-btn" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Cancel
                </button>
                <button type="submit" id="modal-save-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // UI elements
    const messageBox = document.getElementById('message-box');
    const fileInput = document.getElementById('file-input');
    const vcfTable = document.getElementById('vcf-table');
    const exportSelectedBtn = document.getElementById('export-selected-btn');
    const addContactBtn = document.getElementById('add-contact-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const exportSelectionContainer = document.getElementById('export-selection-container');
    const exportList = document.getElementById('export-list');
    const exportSelectAllCheckbox = document.getElementById('export-select-all-checkbox');
    const downloadSelectedBtn = document.getElementById('download-selected-btn');
    const dynamicButtonsContainer = document.getElementById('dynamic-buttons-container');

    // Modal elements
    const editModal = document.getElementById('edit-modal');
    const modalTitle = document.getElementById('modal-title');
    const contactForm = document.getElementById('contact-form');
    const modalRowIndex = document.getElementById('modal-row-index');
    const modalFn = document.getElementById('modal-fn');
    const modalTel = document.getElementById('modal-tel');
    const modalEmail = document.getElementById('modal-email');
    const modalOrg = document.getElementById('modal-org');
    const modalAdr = document.getElementById('modal-adr');
    const modalNote = document.getElementById('modal-note');
    const modalDeleteBtn = document.getElementById('modal-delete-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // App state
    let vcfData = [];
    const vcardProperties = ['FN', 'TEL', 'EMAIL', 'ORG', 'ADR', 'NOTE'];

    // --- Utility Functions ---

    /**
     * Displays a temporary message to the user.
     * @param {string} message The message to display.
     * @param {string} type The message type ('success', 'error', 'info').
     */
    function displayMessage(message, type = 'info') {
        messageBox.textContent = message;
        messageBox.className = 'message-box visible';
        
        // Tailwind classes based on type
        switch(type) {
            case 'success':
                messageBox.classList.add('bg-green-500');
                break;
            case 'error':
                messageBox.classList.add('bg-red-500');
                break;
            case 'info':
            default:
                messageBox.classList.add('bg-gray-800');
                break;
        }

        setTimeout(() => {
            messageBox.classList.remove('visible');
            setTimeout(() => {
                messageBox.className = 'message-box'; // Reset classes after fade out
            }, 300);
        }, 3000);
    }
    
    /**
     * Parses a VCF file string into a structured object array.
     * @param {string} vcfContent The content of the VCF file.
     * @returns {any[]} An array of vCard objects.
     */
    function parseVCF(vcfContent) {
        const vcards = [];
        const lines = vcfContent.split(/\r?\n/);
        let currentVcard = {};

        for (const line of lines) {
            if (line.trim() === 'BEGIN:VCARD') {
                currentVcard = {};
            } else if (line.trim() === 'END:VCARD') {
                if (Object.keys(currentVcard).length > 0) {
                    vcards.push(currentVcard);
                }
            } else if (line.trim() !== '') {
                const parts = line.split(':');
                const property = parts[0].split(';')[0];
                const value = parts.slice(1).join(':');
                if (vcardProperties.includes(property)) {
                    currentVcard[property] = value;
                }
            }
        }
        return vcards;
    }

    /**
     * Renders the VCF data into an HTML table.
     * @param {any[]} vcards The array of vCard objects.
     */
    function renderTable(vcards) {
        vcfData = vcards;
        vcfTable.innerHTML = '';
        
        // Render header
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');
        const selectHeader = document.createElement('th');
        selectHeader.innerHTML = '<input type="checkbox" id="select-all-checkbox">';
        tr.appendChild(selectHeader);
        const actionsHeader = document.createElement('th');
        actionsHeader.textContent = 'Actions';
        tr.appendChild(actionsHeader);
        vcardProperties.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            tr.appendChild(th);
        });
        thead.appendChild(tr);
        vcfTable.appendChild(thead);

        // Render body
        const tbody = document.createElement('tbody');
        vcfData.forEach((row, rowIndex) => {
            const rowElement = document.createElement('tr');
            
            const selectCell = document.createElement('td');
            selectCell.innerHTML = `<input type="checkbox" class="select-row-checkbox" data-row-index="${rowIndex}">`;
            rowElement.appendChild(selectCell);

            const actionsCell = document.createElement('td');
            actionsCell.innerHTML = `
                <button class="edit-btn text-blue-600 hover:text-blue-800 font-semibold mr-2" data-row-index="${rowIndex}">Edit</button>
            `;
            rowElement.appendChild(actionsCell);

            vcardProperties.forEach(col => {
                const cell = document.createElement('td');
                cell.textContent = row[col] || '';
                rowElement.appendChild(cell);
            });
            tbody.appendChild(rowElement);
        });
        vcfTable.appendChild(tbody);
        
        // Show the hosting section and enable buttons
        dynamicButtonsContainer.classList.remove('hidden');

        // Hide the export selection list
        exportSelectionContainer.classList.add('hidden');
        document.querySelector('.vcf-table-container').classList.remove('hidden');
    }

    /**
     * Reconstructs the VCF string from the table data.
     * @param {any[]} contacts The array of vCard objects to export.
     * @returns {string} The reconstructed VCF content.
     */
    function reconstructVCF(contacts) {
        let vcfString = '';
        contacts.forEach(vcard => {
            if (!vcard) return;
            vcfString += 'BEGIN:VCARD\n';
            vcfString += 'VERSION:3.0\n';
            for (const prop of vcardProperties) {
                if (vcard[prop]) {
                    vcfString += `${prop}:${vcard[prop]}\n`;
                }
            }
            vcfString += 'END:VCARD\n';
        });
        return vcfString;
    }
    
    /**
     * Opens the modal to edit or add a contact.
     * @param {number | null} rowIndex The index of the contact to edit, or null for a new contact.
     */
    function openEditModal(rowIndex = null) {
        modalRowIndex.value = rowIndex !== null ? rowIndex : '';
        if (rowIndex !== null) {
            const contact = vcfData[rowIndex];
            modalTitle.textContent = 'Edit Contact';
            modalFn.value = contact.FN || '';
            modalTel.value = contact.TEL || '';
            modalEmail.value = contact.EMAIL || '';
            modalOrg.value = contact.ORG || '';
            modalAdr.value = contact.ADR || '';
            modalNote.value = contact.NOTE || '';
            modalDeleteBtn.style.display = 'inline-block';
        } else {
            modalTitle.textContent = 'Add New Contact';
            contactForm.reset();
            modalDeleteBtn.style.display = 'none';
        }
        editModal.classList.add('open');
    }

    /**
     * Closes the edit modal.
     */
    function closeEditModal() {
        editModal.classList.remove('open');
    }

    // --- Event Listeners ---
    
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const vcfContent = e.target.result;
                    const parsedData = parseVCF(vcfContent);
                    renderTable(parsedData);
                    displayMessage('File uploaded and ready for editing!', 'success');
                } catch (error) {
                    console.error('Error processing VCF file:', error);
                    displayMessage('Failed to parse the VCF file. Please ensure it is a valid format.', 'error');
                }
            };
            reader.onerror = () => {
                displayMessage('Error reading file.', 'error');
            };
            reader.readAsText(file);
        }
    });

    // Delegated event listener for edit and export buttons
    vcfTable.addEventListener('click', (event) => {
        const rowIndex = parseInt(event.target.dataset.rowIndex, 10);
        if (event.target.classList.contains('edit-btn')) {
            openEditModal(rowIndex);
        }
    });

    // Handle form submission
    contactForm.addEventListener('submit', (event) => {
        event.preventDefault();
        
        const rowIndex = modalRowIndex.value !== '' ? parseInt(modalRowIndex.value, 10) : null;
        const newContact = {
            FN: modalFn.value,
            TEL: modalTel.value,
            EMAIL: modalEmail.value,
            ORG: modalOrg.value,
            ADR: modalAdr.value,
            NOTE: modalNote.value
        };

        if (rowIndex !== null) {
            // Editing existing contact
            vcfData[rowIndex] = newContact;
            displayMessage('Contact updated successfully!', 'success');
        } else {
            // Adding a new contact
            vcfData.push(newContact);
            displayMessage('New contact added successfully!', 'success');
        }

        renderTable(vcfData);
        closeEditModal();
    });

    // Modal buttons
    modalCancelBtn.addEventListener('click', closeEditModal);

    modalDeleteBtn.addEventListener('click', () => {
        const rowIndex = parseInt(modalRowIndex.value, 10);
        if (rowIndex !== undefined && vcfData[rowIndex]) {
            vcfData.splice(rowIndex, 1);
            renderTable(vcfData);
            displayMessage('Contact deleted successfully!', 'success');
            closeEditModal();
        }
    });

    // Close modal on outside click
    editModal.addEventListener('click', (event) => {
        if (event.target === editModal) {
            closeEditModal();
        }
    });

    addContactBtn.addEventListener('click', () => {
        openEditModal(null);
    });

    deleteSelectedBtn.addEventListener('click', () => {
        const selectedRows = Array.from(document.querySelectorAll('.select-row-checkbox:checked'))
            .map(checkbox => parseInt(checkbox.dataset.rowIndex, 10))
            .sort((a, b) => b - a); // Sort in descending order to avoid index issues
        
        if (selectedRows.length === 0) {
            displayMessage('Please select one or more rows to delete.', 'info');
            return;
        }

        selectedRows.forEach(index => {
            vcfData.splice(index, 1);
        });
        
        renderTable(vcfData);
        displayMessage(`${selectedRows.length} contact(s) deleted.`, 'success');
    });

    vcfTable.addEventListener('change', (event) => {
        if (event.target.id === 'select-all-checkbox') {
            const isChecked = event.target.checked;
            document.querySelectorAll('.select-row-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }
    });

    // --- Export Selection Logic ---
    exportSelectedBtn.addEventListener('click', () => {
        if (vcfData.length === 0) {
            displayMessage('No contacts to export.', 'info');
            return;
        }
        renderExportSelectionList();
        exportSelectionContainer.classList.remove('hidden');
        document.querySelector('.vcf-table-container').classList.add('hidden');
    });

    function renderExportSelectionList() {
        exportList.innerHTML = '';
        vcfData.forEach((contact, index) => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-4 p-3 bg-gray-50 rounded-lg';
            li.innerHTML = `
                <input type="checkbox" id="export-contact-${index}" class="export-checkbox" data-index="${index}">
                <label for="export-contact-${index}" class="flex-grow cursor-pointer">${contact.FN || 'Untitled Contact'}</label>
            `;
            exportList.appendChild(li);
        });
    }

    exportSelectAllCheckbox.addEventListener('change', (event) => {
        const isChecked = event.target.checked;
        document.querySelectorAll('.export-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateDownloadBtnState();
    });

    exportList.addEventListener('change', () => {
        updateDownloadBtnState();
    });

    function updateDownloadBtnState() {
        const checkedCount = document.querySelectorAll('.export-checkbox:checked').length;
        if (checkedCount > 0) {
            downloadSelectedBtn.disabled = false;
            downloadSelectedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            downloadSelectedBtn.disabled = true;
            downloadSelectedBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    downloadSelectedBtn.addEventListener('click', () => {
        const selectedContacts = Array.from(document.querySelectorAll('.export-checkbox:checked'))
            .map(checkbox => vcfData[parseInt(checkbox.dataset.index, 10)]);

        if (selectedContacts.length === 0) {
            displayMessage('Please select at least one contact to download.', 'error');
            return;
        }

        const vcfContent = reconstructVCF(selectedContacts);
        const blob = new Blob([vcfContent], { type: 'text/vcf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'selected_contacts.vcf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        displayMessage('Selected contacts downloaded successfully!', 'success');
        
        // Return to the main table view
        exportSelectionContainer.classList.add('hidden');
        document.querySelector('.vcf-table-container').classList.remove('hidden');
    });
</script>

</body>
</html>
